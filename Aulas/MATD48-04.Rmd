---
title: "Fundamentos de Análise para Planejamento Experimental"
subtitle: "Noções de Modelos Lineares para Planejamento experimental"
author: "Raydonal Ospina"
output:
  xaringan::moon_reader:
    css: ["default", "metropolis", "metropolis-fonts", "custom-styles.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
bibliography: refs.bib
csl: apa.csl    
link-citations: true
---


```{r setup, include=FALSE}
# Opções globais do Knitr
options(html.tag.transform.rmarkdown = function(x) x)
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center', message = FALSE, warning = FALSE, fig.width=8, fig.height=4.5)

# Carregar pacotes necessários
library(ggplot2)
library(dplyr)
library(MASS) # Para a função ginv()
library(DiagrammeR)
library(sf)
library(tidyverse)
```

class: center, middle, inverse

# Fundamentos e Estrutura de Modelos Lineares

<!-- (Seções 3.1 a 3.5) -->

---

## Modelos Lineares Estatísticos

Modelos lineares estatísticos são a espinha dorsal da análise de dados experimentais. Eles nos permitem modelar a relação entre uma variável de resposta e um ou mais fatores ou variáveis preditoras.

.pull-left[
**Estrutura Matemática Geral:**

$$ Y = \beta_0 + \beta_1 X_1 + \dots + \beta_p X_p + \epsilon $$

- **Componente Determinístico:** $\beta_0 + \beta_1 X_1 + \dots + \beta_p X_p$. Descreve a relação *média* entre Y e os X's.
- **Componente Estocástico:** $\epsilon$. Representa a variabilidade aleatória não explicada pelo modelo, incluindo erros de medição e variação biológica/natural.
]
.pull-right[
```{r, echo=FALSE}
set.seed(42)
x <- 1:20
y <- 2.5 * x + rnorm(20, 0, 10)
qplot(x, y, geom = c("point", "smooth"), method = "lm", se = FALSE) + 
  theme_minimal(base_size = 14) + labs(title="Exemplo Visual de um Modelo Linear", x="Preditor (X)", y="Resposta (Y)")
```
]

---

## 3.1 Relações entre Fatores

Na definição de fator, foi dito que um **fator** define uma partição da população sob estudo. Cada componente desta partição (um subconjunto de elementos da população) corresponde a um **nível** do fator. A complexidade e a validade de um modelo dependem crucialmente de como os múltiplos fatores se relacionam.

**Exemplo:** 
- **População:** Habitantes de Recife.
- **Fator:** `Bairro` (define uma partição na população segundo um critério geográfico) .
- **Níveis:** `Boa Viagem`, `Casa Forte`, `Pina`, `Várzea`, etc. (são apenas níveis do fator)

```{r, echo=FALSE, fig.height=3, message=FALSE, }
# Importando o shapefile
recife = st_read(dsn = "Bairros_Recife/bairros-polygon.shp", quiet = TRUE)
## Para plotar somente o contorno do objeto recife
ggplot(recife) +
  geom_sf(fill = "White")+theme_bw()
```
---
Em várias situações práticas há interesse em considerar a existência de mais de um fator. Quando isso acontece é de fundamental importância identificar as relações entre eles. As possíveis relações são:

1.  **Embutimento (Aninhamento):** Uma relação hierárququica.
2.  **Cruzamento:** Uma relação fatorial completa.
3.  **Confundimento:** Uma falha de delineamento onde os efeitos são indistinguíveis.

Compreender essas relações é o primeiro passo para construir um modelo estatístico correto.


## Fatores Embutidos (Aninhados)

Um fator `B` é dito estar **embutido** (ou aninhado) em um fator `A` se todos os elementos pertencentes a um nível do fator `B` também pertencem obrigatoriamente a um mesmo nível de `A`.

**Exemplo:**
- **População:** Habitantes da região metropolitana de Recife.
- **Fator `Cidade`:** Com 4 níveis: Paulista (P), Olinda (O), Recife (R), Jaboatão (J).
- **Fator `Localização`:** Com 2 níveis: centro (L1) e subúrbio (L2).
---

Note que, simplesmente afirmar que um indivíduo mora no "centro" (nível de `Localização`) não é suficiente para determinar sua residência. É preciso saber **em que cidade**. O centro de Recife é diferente do centro de Olinda. Dessa forma, diz-se que o fator `Localização` está **EMBUTIDO** no fator `Cidade`.

Um gráfico de boxplot pode ilustrar a estrutura hierárquica.

```{r, fig.height=4, echo=FALSE}
# Simulação de dados para o exemplo
set.seed(1)
dados_aninhados_corrigido <- data.frame(
  Cidade = factor(rep(c("Paulista", "Olinda", "Recife", "Jaboatão"), each = 20)),
  Localizacao = factor(rep(c("Centro", "Subúrbio"), each = 10, times = 4))
)

# Gerando renda para cada uma das 8 combinações únicas
dados_aninhados_corrigido$Renda <- round(c(
  rnorm(10, mean = 2200, sd = 400), # Paulista Centro
  rnorm(10, mean = 1800, sd = 300), # Paulista Subúrbio
  rnorm(10, mean = 2800, sd = 500), # Olinda Centro
  rnorm(10, mean = 2200, sd = 400), # Olinda Subúrbio
  rnorm(10, mean = 5000, sd = 1000),# Recife Centro
  rnorm(10, mean = 3000, sd = 700), # Recife Subúrbio
  rnorm(10, mean = 1900, sd = 300), # Jaboatão Centro
  rnorm(10, mean = 1700, sd = 250)  # Jaboatão Subúrbio
))

ggplot(dados_aninhados_corrigido, aes(x = Localizacao, y = Renda, fill = Cidade)) +
  geom_boxplot() +
  facet_wrap(~ Cidade, scales = "free_y") +
  labs(title = "Visualização de Dados Aninhados",
       subtitle = "Renda por Localização DENTRO de cada Cidade",
       x = "Localização", y = "Renda (R$)") +
  theme_minimal(base_size = 14)  +
  theme(legend.position = "none")
```
**Interpretação:** No painel "Recife", vemos uma grande diferença de renda entre "Centro" e "Subúrbio". No painel "Jaboatão", essa diferença é muito menor (cuidado nas escalas de cada painel). Isso demonstra visualmente que o efeito de Localizacao (Centro vs. Subúrbio) é diferente para cada Cidade e só pode ser interpretado dentro desse contexto. Não existe um "efeito de Centro" geral; existe um efeito de "Centro de Recife", um efeito de "Centro de Olinda", etc.
---



### Exemplo Simulado: `Turma` aninhada em `Escola`

```{r}
set.seed(321)
dados_aninhados <- data.frame(
  Escola = factor(rep(c("Escola A", "Escola B", "Escola C"), each = 10)),
  # Criamos um rótulo de turma simples para usar nos eixos do gráfico
  Turma_label = factor(rep(c("T1", "T2"), each = 5, times = 3)),
  # E um identificador único para o modelo
  Turma_ID_unico = factor(rep(c("A.T1", "A.T2", "B.T1", "B.T2", "C.T1", "C.T2"), each = 5))
)
# Gerando notas para cada uma das 6 combinações únicas
dados_aninhados$Nota = round(c(rnorm(5, 85, 4), rnorm(5, 82, 4), # Turmas da Escola A
                               rnorm(5, 75, 5), rnorm(5, 78, 5), # Turmas da Escola B
                               rnorm(5, 65, 3), rnorm(5, 68, 3)), 1) # Turmas da Escola C
```

**Implicação no Modelo:** O efeito de `Turma` deve ser modelado *dentro* do efeito de `Escola`. Um modelo aditivo `Nota ~ Escola + Turma` estaria **incorreto**. O modelo correto em R é `Nota ~ Escola / Turma` ou  `Nota ~ Escola + Escola:Turma_label`

---

O boxplot revela a estrutura hierárquica. Vemos a variação entre turmas *dentro* de cada escola, e a variação entre as escolas.

```{r, fig.height=4}
ggplot(dados_aninhados, aes(x = Turma_label, y = Nota, fill = Turma_label)) +
  geom_boxplot() +
  facet_wrap(~ Escola) +
  labs(title = "Escala Fixa", subtitle = "Permite comparar os níveis entre escolas") +
  theme_minimal(base_size = 12) + theme(legend.position = "none")
```

**Interpretação Gráfica:** A comparação principal é entre Escolas. A comparação entre "A.T1" e "B.T1" não é direta, pois são populações de alunos diferentes em contextos diferentes.

---


## Fatores Cruzados

Dois fatores `A` e `B` são ditos **cruzados** quando cada nível de `A` ocorre em combinação com **todos** os níveis de `B`, ou seja quando nenhum deles está embutido no outro.

**Exemplo:**
- **População:** Habitantes da região metropolitana de Recife.
- **Fator `Cidade`:** Paulista, Olinda, Recife, Jaboatão.
- **Fator `Sexo`:** Masculino, Feminino.

Os fatores `Cidade` e `Sexo` são **CRUZADOS**, pois um homem pode morar em qualquer cidade, assim como uma mulher.

---

### Visualizando Dados Cruzados e Interação (perfil)

```{r, fig.height=5, echo=FALSE}
# Simulação de dados
set.seed(2)
dados_cruzados <- data.frame(
  Cidade = factor(rep(c("Paulista", "Olinda", "Recife", "Jaboatão"), each = 20)),
  Sexo = factor(rep(c("Masc", "Fem"), each = 10, times = 4)),
  Renda = round(runif(80, 1000, 5000))
)

ggplot(dados_cruzados, aes(x = Cidade, y = Renda, color = Sexo, group = Sexo)) +
  stat_summary(fun = mean, geom = "point", size = 4) +
  stat_summary(fun = mean, geom = "line", linewidth = 1.5) +
    # facet_wrap(~ Sexo, scales = "free_y") +
  labs(title = "Gráfico de Interação: Cidade x Sexo",
       subtitle = "Linhas paralelas sugerem ausência de interação",
       y = "Renda Média") +
  theme_minimal(base_size = 14)
```
**Interpretação:** Se as linhas não são paralelas, o efeito de um fator depende do nível do outro (interação).
---


### Exemplo Simulado: `Droga` x `Dieta`

```{r}
set.seed(456)
dados_cruzados <- data.frame(
  Droga = factor(rep(c("Droga A", "Droga B"), each = 10)),
  Dieta = factor(rep(c("Normal", "Hipercalórica"), times = 2, each = 5)),
  Resposta = round(c(rnorm(5, 50, 8), rnorm(5, 52, 8), # Droga A
                     rnorm(5, 60, 8), rnorm(5, 40, 8)), 1) # Droga B
)
```
**Implicação no Modelo:** Permite estimar **efeitos principais** e a **interação**. O modelo em R é `Resposta ~ Droga * Dieta`.

---

### Visualizando Dados Cruzados: Efeitos Principais

O Boxplot permite visualizar os efeitos principais de cada fator separadamente
.pull-left[
```{r, fig.height=4.5, echo=FALSE}
ggplot(dados_cruzados, aes(x = Droga, y = Resposta, fill = Droga)) +
  geom_boxplot() + labs(title = "Efeito Principal da Droga") +
  theme_minimal(base_size = 12) + theme(legend.position = "none")
```
]
.pull-right[
```{r, fig.height=4.5, echo=FALSE}
ggplot(dados_cruzados, aes(x = Dieta, y = Resposta, fill = Dieta)) +
  geom_boxplot() + labs(title = "Efeito Principal da Dieta") +
  theme_minimal(base_size = 12) + theme(legend.position = "none")
```
]

---

### Visualizando Dados Cruzados: Interação

Um gráfico de interação (ou de perfis) é a melhor ferramenta para visualizar se os efeitos são aditivos ou se interagem. Isso mostra o efeito médio de um fator, ignorando (ou agregando sobre) os níveis do outro. Corresponde conceitualmente às linhas "Droga" e "Dieta" na tabela de ANOVA.


```{r, fig.height=3.5, echo=FALSE}
ggplot(dados_cruzados, aes(x = Droga, y = Resposta, color = Dieta, group = Dieta)) +
  stat_summary(fun = mean, geom = "point", size = 4) +
  stat_summary(fun = mean, geom = "line", linewidth = 1.5) +
  labs(title = "Gráfico de Interação: Droga x Dieta",
       subtitle = "Linhas não paralelas sugerem interação",
       y = "Resposta Média") + theme_minimal(base_size = 14)
```

**Interpretação Gráfica:** As linhas se cruzam! O efeito da Droga B é positivo na dieta Normal, mas negativo na Hipercalórica. Isso é uma **interação qualitativa** forte. Um modelo sem o termo de interação falharia em capturar essa dinâmica crucial.

---


## Fatores Confundidos

Dois fatores `A` e `B` são ditos **completamente confundidos** quando não é possível separar/distinguir os seus efeitos um do outro.

**Exemplo:** Em um experimento com 3 unidades experimentais, cada uma recebendo um tratamento diferente.
- Unidade 1 recebe Tratamento 1
- Unidade 2 recebe Tratamento 2
- Unidade 3 recebe Tratamento 3

Nessa situação, diferenças observadas na variável-resposta podem ser atribuídas tanto às diferenças entre os **tratamentos** quanto às diferenças inerentes entre as **unidades experimentais**.

Assim, diz-se que o fator `Tratamento` está **COMPLETAMENTE CONFUNDIDO** com o fator `Unidade Experimental`. Isso é uma falha de delineamento que impede a inferência causal.

---


### Exemplo de Confundimento: O Caso de Recife

**Cenário:** A prefeitura implementa um novo programa de incentivo ao comércio local (`Programa`). Por questões logísticas, o programa é implementado apenas em bairros de alta renda, enquanto os bairros de baixa renda servem como grupo de controle (não recebem o programa).

- **Tratamento:** `Programa` (Níveis: "Incentivo", "Controle").
- **Característica dos Bairros:** `Nível de Renda` (Níveis: "Alto", "Baixo").
- **Resposta:** `Faturamento Médio` do comércio local.

**O Problema:** O fator `Programa` está **completamente confundido** com o fator `Nível de Renda`.
- Bairros de Alta Renda **SEMPRE** recebem o programa.
- Bairros de Baixa Renda **NUNCA** recebem o programa.

---

### Exemplo de Confundimento em R e Visualização

Vamos simular os dados para este cenário.

```{r}
set.seed(555)
# Criando os dados confundidos
dados_recife_confundido <- data.frame(
  Bairro = c("Boa Viagem", "Casa Forte", "Pina", "Várzea", "Brasília Teimosa", "Afogados"),
  Nivel_Renda = factor(rep(c("Alto", "Baixo"), each = 3)),
  Programa = factor(rep(c("Incentivo", "Controle"), each = 3))
)

# Simulando o faturamento. Bairros de alta renda naturalmente já têm faturamento maior.
dados_recife_confundido$Faturamento <- c(
  rnorm(3, mean = 500, sd = 50), # Faturamento nos bairros de alta renda
  rnorm(3, mean = 200, sd = 30)  # Faturamento nos bairros de baixa renda
)
```
---

**Visualizando o Problema:**
```{r, fig.height=4}
ggplot(dados_recife_confundido, aes(x = Programa, y = Faturamento, fill = Nivel_Renda)) +
  geom_boxplot(alpha=0.6) +
  geom_jitter(width=0.1, size=3) +
  labs(title = "Efeito Aparente do Programa de Incentivo",
       subtitle = "O efeito do programa está confundido com o nível de renda dos bairros",
       x = "Grupo do Programa",
       y = "Faturamento Médio (em milhares de R$)") +
  theme_minimal(base_size = 14)
```

---

### Interpretação do Exemplo de Confundimento

O gráfico mostra claramente que o grupo "Incentivo" tem um faturamento muito maior que o grupo "Controle".

**Podemos concluir que o programa de incentivo foi um sucesso?**

**NÃO. É impossível saber.** A diferença observada pode ser devida:
1.  Ao **efeito real** do programa de incentivo.
2.  À **diferença preexistente** no poder de compra e faturamento dos bairros de alta e baixa renda.
3.  A uma combinação de ambos.

Como a `Nível_Renda` e o `Programa` variam em perfeita sincronia, seus efeitos são matematicamente indistinguíveis. Não podemos isolar o impacto causal do programa.

**Solução:** Um delineamento experimental melhor teria que quebrar esse confundimento. Por exemplo, sorteando aleatoriamente *tanto bairros de alta quanto de baixa renda* para receberem o programa de incentivo.

---



### Fatores Confundidos: Outro exemplo simulado em R

Vamos simular exatamente o cenário descrito para demonstrar o problema do confundimento.

**Cenário Simulado:**
1.  Temos 3 **Unidades Experimentais** (por exemplo, 3 pacientes). Cada paciente tem uma "resposta base" diferente devido à sua fisiologia.
    - Paciente 1: Resposta base alta (ex: 20)
    - Paciente 2: Resposta base média (ex: 15)
    - Paciente 3: Resposta base baixa (ex: 10)
2.  Temos 3 **Tratamentos** com efeitos reais diferentes.
    - Tratamento 1 (T1): Adiciona 5 unidades à resposta.
    - Tratamento 2 (T2): Adiciona 10 unidades à resposta.
    - Tratamento 3 (T3): Adiciona 15 unidades à resposta.

**O Delineamento Confundido:**
- Paciente 1 (o melhor) recebe Tratamento 1.
- Paciente 2 (o médio) recebe Tratamento 2.
- Paciente 3 (o pior) recebe Tratamento 3.

---
### Simulação em R e Visualização do Confundimento

```{r}
# Definindo os efeitos REAIS (que na prática seriam desconhecidos)
efeito_unidade <- c(20, 15, 10)  # Efeito inerente de cada paciente
efeito_tratamento <- c(5, 10, 15) # Efeito de cada tratamento

# Criando o dataframe com o delineamento confundido
dados_confundidos_sim <- data.frame(
  Unidade = factor(c("Paciente 1", "Paciente 2", "Paciente 3")),
  Tratamento = factor(c("T1", "T2", "T3"))
)

# A resposta observada é a soma dos efeitos + um pequeno ruído aleatório
set.seed(123)
dados_confundidos_sim$Resposta_Observada <- efeito_unidade + efeito_tratamento + rnorm(3, 0, 0.5)

print(dados_confundidos_sim)
```
---

**Visualizando os Resultados:**
```{r, fig.height=4.5}
ggplot(dados_confundidos_sim, aes(x = Tratamento, y = Resposta_Observada, fill = Unidade)) +
  geom_col(width=0.7) +
  geom_text(aes(label = round(Resposta_Observada, 1)), vjust = 1.5, color = "white", size = 5) +
  labs(title = "Resultados do Experimento Confundido",
       subtitle = "Qual efeito causou a diferença nas respostas?",
       y = "Resposta Observada") +
  theme_minimal(base_size = 14)
```

---
### A Impossibilidade de Separar os Efeitos

Observando os resultados, vemos uma diferença clara: `T3 > T2 > T1`.

**A pergunta é: A que se deve essa diferença?**
- É porque o Tratamento 3 é o melhor? (O que é verdade em nossa simulação).
- Ou é porque o Paciente 3 é diferente dos outros? (O que também é verdade).

A resposta observada para o `T3` (~25) é a soma do `efeito_unidade` (10) e do `efeito_tratamento` (15). A resposta para o `T1` (~25) é a soma de `efeito_unidade` (20) e `efeito_tratamento` (5). **Os resultados observados acabam sendo muito parecidos por uma coincidência dos efeitos opostos!**
---

Se tentarmos ajustar um modelo em R, ele falhará ou dará um aviso:

```{r, echo=TRUE}
# Tentativa de ajustar um modelo para separar os efeitos
# O R irá reclamar que o modelo não é de posto completo
modelo_confundido <- lm(Resposta_Observada ~ Unidade + Tratamento, data = dados_confundidos_sim)
summary(modelo_confundido)
```
**Interpretação do Erro:** O R nos informa que os coeficientes não podem ser estimados porque `Unidade` e `Tratamento` são **perfeitamente colineares**. A coluna da matriz do modelo para "Paciente 2" é uma combinação linear das outras, e o mesmo para "Tratamento T2", etc. Matematicamente, é impossível resolver o sistema de equações.

**Conclusão:** O confundimento é uma falha estrutural do delineamento experimental que a análise estatística **não pode consertar**.
---
  

##  Estruturas de Classificação Balanceadas e Completas

Uma estrutura de classificação é dita **BALANCEADA** e **completa** quando:
1.  Para cada uma de todas as **possíveis combinações** dos níveis dos fatores, existe pelo menos um elemento.
2.  Todas as possíveis combinações possuem um **mesmo número de elementos** (mesmo número de réplicas).

.pull-left[
**Estrutura Balanceada:**
```{r}
df_bal <- data.frame(FatorA = rep(c("A1","A2"), each=4), 
                     FatorB = rep(c("B1","B2"), 4))
table(df_bal)
```
]
.pull-right[
**Estrutura Desbalanceada:**
```{r}
df_unbal <- df_bal[-1, ]
table(df_unbal)
```
]

**Importância:** Delineamentos balanceados garantem que os efeitos dos fatores sejam **ortogonais** (independentes), o que simplifica enormemente a análise e a interpretação. Daqui para adiante, a teoria apresentada refere-se a estruturas balanceadas e completas, a menos que haja referência contrária.

---

class: center, middle, inverse

## Representação de Estruturas em Diagramas de Hasse

---

### Aprofundando: O que é um Diagrama de Hasse?

As relações entre fatores de interesse podem ser convenientemente representadas por meio de diagramas de Hasse. Essa forma de representar esquematicamente estruturas de classificação foram estudadas extensamente por Throckomorton, 1961.


Um Diagrama de Hasse é a representação gráfica de um **conjunto parcialmente ordenado (poset)**. No nosso contexto:
- **O conjunto:** É composto pelos fatores do modelo, mais a média geral ($\mu$) e o termo de erro residual ($\epsilon$).
- **A relação de ordem ($\preceq$):** É definida pela **relação de aninhamento**. Dizemos que $B \preceq A$ ("B precede ou é igual a A") se o fator B está aninhado no (ou é contido pelo) fator A.

O diagrama simplifica a visualização desta ordem, mostrando apenas as relações de "cobertura" (se $B \preceq A$ e não existe um C tal que $B \preceq C \preceq A$, então desenhamos uma linha de B para A). A direção da hierarquia é implícita (de baixo para cima).
---

### Por que isso é fundamental?
A estrutura de ordem parcial do diagrama dita diretamente:
1.  Quais termos são permitidos no modelo estatístico.
2.  Quais médias são "admissíveis" para cálculo e interpretação.
3.  Como a Soma de Quadrados deve ser particionada na ANOVA.

**Tradução para R:** O operador de aninhamento é `/`.
O modelo para o efeito de `B` aninhado em `A` é:
`~ A / B`
que é expandido pelo R para:
`~ A + A:B`

**Tradução para R:** O operador de cruzamento é `*`.
O modelo para `A` e `B` cruzados é:
`~ A * B`
que é expandido pelo R para:
`~ A + B + A:B`

---

## Diagramas de Hasse 

<!-- As relações entre fatores de interesse podem ser convenientemente representadas por meio de diagramas de Hasse. Essa forma de representar esquematicamente estruturas de classificação foram estudadas extensamente por Throckomorton, 1961. -->

A Figura abaixo ilustra, através desses diagramas, as duas possíveis estruturas com dois fatores.

.pull-left[
Representação da situação em que o fator **B está embutido** no fator A.
```{r, echo=FALSE, fig.height=3.5}
grViz("digraph { rankdir=TB; node[shape=circle]; edge[arrowhead=none]; mu->A->B->epsilon; epsilon[label='ε']; mu[label='μ'] }")
```
]
.pull-right[
Representação no caso em que **A e B são cruzados**.
```{r, echo=FALSE, fig.height=3.5}
grViz("digraph { rankdir=TB; node[shape=circle]; edge[arrowhead=none]; mu->{A,B}->epsilon; epsilon[label='ε']; mu[label='μ']; {rank=same; A;B} }")
```
]

Relações de completo **confundimento** entre fatores seriam representadas por um **mesmo ponto** para todos os fatores confundidos. **Portanto, ao desenhar o diagrama de Hasse para o seu delineamento experimental, você está, na verdade, especificando a fórmula correta do seu modelo estatístico.**
---


### EXERCÍCIO EM CLASSE

**Desenhemos os diagramas de Hasse correspondentes a cada uma das 5 estruturas possíveis de classificação com 3 fatores (A, B e C).**

```{r, echo=FALSE}
# Definir um estilo padrão para todos os gráficos para evitar repetição
graph_attrs <- "
  rankdir=TB;
  node [shape=circle, style=filled, fillcolor=lightblue];
  edge [arrowhead=none];
"
```
.pull-left[
**1. Totalmente Cruzados (A * B * C)**
```{r,  echo=FALSE}
grViz(paste0("digraph {", graph_attrs, "
  mu [label='μ'];
  epsilon [label='ε'];
  mu -> {A, B, C};
  {A, B, C} -> epsilon [arrowhead=none];
  {rank=same; A; B; C;}
}"))
```
]
.pull-right[
**2. Totalmente Aninhados (A / B / C)**
```{r, echo=FALSE}
grViz(paste0("digraph {", graph_attrs, "
  mu [label='μ'];
  epsilon [label='ε'];
  mu -> A -> B -> C -> epsilon;
}"))
```
]
---

.pull-left[
**3. (A ⊃ B) x C**  (Lê-se: `C` cruzado com `B` aninhado em `A`. Modelo: `C * A/B`)
```{r, echo=FALSE}
grViz(paste0("digraph {", graph_attrs, "
  mu [label='μ'];
  epsilon [label='ε'];
  mu -> {A, C};
  A -> B;
  {B, C} -> epsilon;
}"))
```
]
.pull-right[
**4. A ⊃ (B x C)**  (Lê-se: `B` e `C` cruzados, aninhados em `A`. Modelo: `A/(B*C)`)
```{r, echo=FALSE}
grViz(paste0("digraph {", graph_attrs, "
  mu [label='μ'];
  epsilon [label='ε'];
  mu -> A;
  A -> {B, C};
  {B, C} -> epsilon;
  {rank=same; B; C;}
}"))
```
]
---

**5. Confundidos**
```{r, echo=FALSE}
grViz(paste0("digraph {", graph_attrs, "
  mu [label='μ'];
  epsilon [label='ε'];
  ABC [label='(A,B,C)'];
  mu -> ABC -> epsilon;
}"))
```
---

### O Diagrama de Hasse como um Mapa para o Modelo

Vamos revisitar as 5 estruturas possíveis com 3 fatores (A, B, C), mas desta vez com muito mais detalhes. Para cada estrutura, vamos perguntar:

1.  **Qual é a relação fundamental entre os fatores?**
2.  **Dê um exemplo prático e concreto.**
3.  **Como o Diagrama de Hasse representa essa relação?**
4.  **Qual é a fórmula do modelo estatístico em R que corresponde diretamente ao diagrama?**

Esta abordagem transformará o diagrama de uma figura abstrata em uma **ferramenta de modelagem** prática.

---
### Estrutura 1: Fatores Totalmente Cruzados

**1. Relação:** Todos os fatores são independentes. Todas as combinações de níveis de A, B e C são possíveis e foram incluídas no experimento.

**2. Exemplo Prático:** Um ensaio clínico testa o efeito de `Droga` (A: A1, A2), `Dieta` (B: B1, B2) e `Sexo` (C: Masc, Fem) na pressão arterial. Temos pacientes em todas as 8 combinações (A1/B1/Masc, A1/B1/Fem, etc.).

**3. Diagrama de Hasse:**
Mostra A, B e C em paralelo. Nenhum tem precedência sobre o outro. Todos estão "acima" do erro residual e "abaixo" da média geral.
```{r, echo=FALSE, fig.height=2.5}
grViz("digraph { rankdir=TB; node[shape=circle,style=filled,fillcolor=lightblue]; edge[arrowhead=none]; mu->{A,B,C}->epsilon; {rank=same;A,B,C}; mu[label='μ']; epsilon[label='ε'] }")
```

**4. Tradução para Modelo em R:**
O modelo mais completo para esta estrutura inclui todos os efeitos principais e todas as interações possíveis.
`Resposta ~ Droga * Dieta * Sexo`
Que expande para:
`~ Droga + Dieta + Sexo + Droga:Dieta + Droga:Sexo + Dieta:Sexo + Droga:Dieta:Sexo`

---
### Estrutura 2: Fatores Totalmente Aninhados

**1. Relação:** Uma hierarquia estrita. Os níveis de C só existem dentro de um nível específico de B, e os níveis de B só existem dentro de um nível específico de A.

**2. Exemplo Prático:** Amostragem de `Alunos` ($\epsilon$) em diferentes `Turmas` (C), que pertencem a diferentes `Escolas` (B), que estão localizadas em diferentes `Distritos` (A). A "Turma 1" da Escola X não tem relação com a "Turma 1" da Escola Y.

**3. Diagrama de Hasse:**
Mostra uma cadeia linear de dependência, de cima para baixo.
```{r, echo=FALSE, fig.height=2.5}
grViz("digraph { rankdir=TB; node[shape=circle,style=filled,fillcolor=lightblue]; edge[arrowhead=none]; mu->A->B->C->epsilon; mu[label='μ']; epsilon[label='ε'] }")
```

**4. Tradução para Modelo em R:**
O modelo deve refletir essa hierarquia usando o operador de aninhamento `/`.
`Nota ~ Distrito / Escola / Turma`
Que expande para:
`~ Distrito + Distrito:Escola + Distrito:Escola:Turma`
Este modelo estima a variabilidade em cada nível da hierarquia.

---
### Estrutura 3: (A ⊃ B) x C (Aninhamento e Cruzamento Mistos)

**1. Relação:** O fator B está aninhado em A. O fator C é cruzado com A e, por consequência, com B.

**2. Exemplo Prático:** Avaliar o desempenho de `Pacientes` ($\epsilon$) em diferentes `Enfermarias` (B) que estão aninhadas em diferentes `Hospitais` (A). O `Sexo` (C) do paciente é um fator cruzado com a estrutura hospitalar. Uma mulher pode estar em qualquer enfermaria de qualquer hospital.

**3. Diagrama de Hasse:**
A linha `A -> B` mostra o aninhamento. `C` aparece em paralelo, mostrando o cruzamento.
```{r, echo=FALSE, fig.height=2.5}
grViz("digraph { rankdir=TB; node[shape=circle,style=filled,fillcolor=lightblue]; edge[arrowhead=none]; mu->{A,C}; A->B; {B,C}->epsilon; mu[label='μ']; epsilon[label='ε'] }")
```

**4. Tradução para Modelo em R:**
A fórmula combina os operadores `*` e `/`.
`Resposta ~ Sexo * Hospital / Enfermaria`
Que expande para:
`~ Sexo + Hospital + Sexo:Hospital + Hospital:Enfermaria + Sexo:Hospital:Enfermaria`

---
### Estrutura 4: A ⊃ (B x C) (Fatorial Aninhado)

**1. Relação:** Os fatores B e C são cruzados entre si, mas todo o delineamento BxC é replicado dentro de cada nível de A.

**2. Exemplo Prático:** Um Delineamento em Blocos (`Bloco` = A). Dentro de cada Bloco, aplicamos um fatorial completo de `Adubação` (B) e `Variedade` (C). A combinação Adubo1/Variedade1 no Bloco 1 é diferente da mesma combinação no Bloco 2.

**3. Diagrama de Hasse:**
Mostra a estrutura paralela de B e C "abaixo" de A.
```{r, echo=FALSE, fig.height=2.5}
grViz("digraph { rankdir=TB; node[shape=circle,style=filled,fillcolor=lightblue]; edge[arrowhead=none]; mu->A->{B,C}->epsilon; {rank=same;B,C}; mu[label='μ']; epsilon[label='ε'] }")
```

**4. Tradução para Modelo em R:**
`Resposta ~ Bloco / (Adubacao * Variedade)`
Que expande para:
`~ Bloco + Bloco:Adubacao + Bloco:Variedade + Bloco:Adubacao:Variedade`
Este modelo permite ver se o efeito do adubo, da variedade ou de sua interação muda de um bloco para outro.

---
### Estrutura 5: Fatores Confundidos

**1. Relação:** É impossível separar os efeitos de A, B e C. Conhecer o nível de um fator determina completamente o nível dos outros.

**2. Exemplo Prático:** Um pesquisador testa 3 `Dietas` (A), 3 `Programas de Exercício` (B) e 3 `Suplementos` (C). Mas o Paciente 1 recebe a combinação (Dieta1, Exercicio1, Suplemento1), o Paciente 2 a (Dieta2, Exercicio2, Suplemento2), etc.

**3. Diagrama de Hasse:**
Todos os fatores colapsam em um único nó, pois são indistinguíveis.
```{r, echo=FALSE, fig.height=2.3}
grViz("digraph { rankdir=TB; node[shape=circle,style=filled,fillcolor=lightcoral]; edge[arrowhead=none]; mu[label='μ']; epsilon[label='ε']; ABC[label='(A,B,C)']; mu->ABC->epsilon }")
```

**4. Tradução para Modelo em R:**
Não existe um modelo estatístico que possa separar os efeitos. Se você tentar `Resposta ~ A + B + C`, o software retornará um erro de singularidade/colinearidade. O experimento está **fatalmente falho**. O diagrama de Hasse, se desenhado durante a fase de planejamento, teria revelado este erro *a priori*.



### Exemplo Prático: A Lógica por Trás do Delineamento em Blocos (RCBD)

Vamos usar um exemplo clássico para ilustrar como o Diagrama de Hasse nos guia para o modelo correto e por que isso é tão poderoso.

**Cenário Experimental:**
- **Objetivo:** Testar se 3 tipos de fertilizante (`Tratamento`: A, B, C) afetam a produção de uma cultura.
- **Problema:** O campo experimental não é homogêneo. Há um gradiente de umidade e fertilidade da esquerda para a direita. As parcelas à direita são naturalmente mais produtivas.
- **Variável Indesejada:** Esta variação espacial é um "ruído" que pode mascarar o verdadeiro efeito dos fertilizantes.

**A pergunta é: como podemos separar o "sinal" (efeito do Tratamento) do "ruído" (efeito da posição no campo)?**
---
### Análise Incorreta (Ignorando o Problema):

Se distribuirmos os tratamentos de forma inteiramente aleatória (DIC), a variabilidade do solo inflará nosso erro experimental.
```{r}
set.seed(99)
efeito_bloco <- c(0, 4, 8, 12)  # Blocos cada vez mais férteis
efeito_trat <- c(0, 5, 0)      # Tratamento B é o melhor
dados_rcbd <- data.frame(
  Bloco = factor(rep(1:4, each = 3)),
  Tratamento = factor(rep(c("A", "B", "C"), times = 4))
) %>%
  mutate(
    Resposta = round(20 + efeito_bloco[as.numeric(Bloco)] + efeito_trat[as.numeric(Tratamento)] + rnorm(12, 0, 1.5), 1)
  )

head(dados_rcbd, 10)
```
---
```{r, fig.height=5, echo=FALSE}
ggplot(dados_rcbd, aes(x = Tratamento, y = Resposta, fill = Tratamento)) +
  geom_boxplot(alpha=0.6) + geom_jitter(width=0.1) +
  labs(title="Análise Incorreta: Ignorando o Efeito do Bloco",
       subtitle="A alta variabilidade DENTRO dos grupos mascara o efeito do tratamento") +
  theme_minimal(base_size=14) + theme(legend.position="none")
```
**Interpretação:** A sobreposição entre os boxplots é enorme. Uma ANOVA `lm(Resposta ~ Tratamento)` provavelmente falharia em detectar a superioridade do Tratamento B.


---
### A Solução Guiada pelo Diagrama de Hasse

**Solução (Bloqueio):** Dividimos o campo em 4 **Blocos**. Em cada bloco, aplicamos todos os 3 tratamentos aleatoriamente.

**Análise das Relações e Diagrama:**
- `Tratamento` e `Bloco` são fatores **cruzados**.
- A interação `Bloco:Tratamento` é confundida com o erro experimental ($\epsilon$).
- O diagrama de Hasse é o de dois fatores cruzados.

```{r, echo=FALSE, fig.height=2.5}
grViz("digraph { rankdir=TB; node[shape=circle,style=filled,fillcolor=lightblue]; edge[arrowhead=none];
mu[label='μ']; epsilon[label='ε'];
      mu->{Bloco,Tratamento}->epsilon }")
```

**Tradução para Modelo Estatístico:**
O diagrama nos obriga a reconhecer o fator `Bloco`. Para controlar seu efeito (e não testá-lo), usamos um modelo aditivo.
**Fórmula Correta:** `Resposta ~ Bloco + Tratamento`

---

### Bloqueio: Visualizando a Análise Correta

O modelo `Resposta ~ Bloco + Tratamento` ajusta os dados removendo o efeito médio de cada bloco. O resultado é como se todas as observações tivessem sido feitas em um campo homogêneo.

**O que este modelo faz matematicamente?**
- Ele calcula a parte da variabilidade total que se deve às diferenças **entre blocos** ($SQ_{Bloco}$).
- Ele calcula a parte da variabilidade que se deve às diferenças **entre tratamentos** ($SQ_{Tratamento}$).
- A variabilidade restante, o "ruído puro", é o resíduo ($SQ_{Resíduo}$).

Ao "subtrair" a $SQ_{Bloco}$ da variabilidade total, o nosso denominador do teste F ($QM_{Resíduo}$) fica muito menor, aumentando o poder para detectar o efeito do `Tratamento`.

```{r, fig.height=4.5, echo=TRUE}
# Ajustando o modelo para obter os resíduos parciais do tratamento
# O modelo calcula o efeito de cada fator
modelo_rcbd <- lm(Resposta ~ Bloco + Tratamento, data = dados_rcbd)
# A tabela ANOVA mostra que tanto Bloco quanto Tratamento são significativos
```
---

```{r, fig.height=4.5, echo=TRUE}
anova(modelo_rcbd)
# A resposta ajustada é o que sobra após remover o "ruído" do bloco
dados_rcbd$Resposta_Ajustada <- resid(modelo_rcbd) + mean(dados_rcbd$Resposta)
head(dados_rcbd)
```
---

**Visualização 2: "Removendo" o Efeito do Bloco (Análise Correta)**

```{r, fig.height=4.5, echo=TRUE}
# 1. Modelo apenas com o bloco
modelo_so_bloco <- lm(Resposta ~ Bloco, data = dados_rcbd)

# 2. Resíduos contêm o efeito do tratamento + erro
dados_rcbd$Resposta_Ajustada_Correta <- residuals(modelo_so_bloco)
```


```{r, fig.height=3.5, echo=FALSE}
# Criando os dados ajustados (removendo o efeito do bloco)
ggplot(dados_rcbd, aes(x = Tratamento, y = Resposta_Ajustada_Correta, fill = Tratamento)) +
  geom_boxplot(alpha=0.6) + geom_jitter(width=0.1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue") +
  labs(title="Análise Correta: Variação Restante Após Remover o Efeito do Bloco",
       subtitle="O efeito real do Tratamento B (valores acima de zero) agora é visível") +
  theme_minimal(base_size=14) + theme(legend.position="none") +
  ylab("Resposta Ajustada (Resíduos do Modelo ~ Bloco)")
```

**Interpretação:** Ao modelar e remover a variabilidade devida aos blocos, a variabilidade residual (o "ruído") diminui drasticamente. Agora, a superioridade do Tratamento B, que era o "sinal" que queríamos detectar, fica clara e estatisticamente significativa. **O Diagrama de Hasse nos levou ao modelo que tornou esta descoberta possível.**
---

### O Diagrama de Hasse como Ferramenta de Diagnóstico *a Priori*

O poder mais significativo do Diagrama de Hasse é no **planejamento** de um experimento. Ele funciona como um "raio-x" da estrutura lógica do seu delineamento, permitindo identificar falhas fatais *antes* de coletar qualquer dado.

Vamos analisar um cenário clássico de erro de planejamento.

**Cenário do Problema:**
Um pesquisador quer testar se um novo `Método de Ensino` (X) é melhor que o tradicional (Y). Ele tem dois professores disponíveis: o experiente `Professor` Silva e a novata Profa. Santos. Para "facilitar", ele decide que:
- O Prof. Silva, por ser mais experiente, usará o novo Método X.
- A Profa. Santos usará o tradicional Método Y.

**A Pergunta de Diagnóstico:** Qual é a estrutura de fatores deste delineamento?

---
### Diagnóstico do Problema via Diagrama de Hasse

**Análise Estrutural:**
- Os fatores são `Professor` e `Método`.
- `Professor` e `Método` são **confundidos**. Se conhecemos o professor de uma turma, automaticamente sabemos o método de ensino utilizado. Os dois fatores variam em perfeita sincronia.

**Passo 1: Desenhar o Diagrama de Hasse do delineamento proposto.**
Como os fatores são indistinguíveis, eles colapsam em um único nó.

.pull-left[
**Diagrama do Delineamento Falho:**
```{r, fig.height=2.5, echo=FALSE}
grViz("
digraph confounded {
  rankdir=TB;
  node [shape=circle, style=filled, fillcolor=lightcoral]; edge[arrowhead=none];
  mu [label = 'μ']; epsilon [label = 'ε'];
  conf [label='(Professor,\n Método)'];
  mu -> conf -> epsilon;
}
")
```
]
.pull-right[
**Diagnóstico:**
O diagrama é um **alerta vermelho visual**. O nó único `(Professor, Método)` mostra que é impossível, matematicamente, separar o efeito de ser ensinado pelo Prof. Silva do efeito de ser ensinado pelo Método X.
]

---
**Conclusão *a Priori*:** Se o grupo do Prof. Silva tiver notas maiores, nunca saberemos se foi por causa do professor ou do método. **O experimento, como planejado, é incapaz de responder à pergunta de pesquisa.**

### Ação Corretiva: Redesenhando o Experimento com o Diagrama

O diagrama não apenas identifica o problema, mas também sugere a solução. Para separar os efeitos, os fatores `Professor` e `Método` precisam estar em **nós separados** no diagrama.

**Ação Corretiva:** Devemos **cruzar** os fatores. Isso significa que *ambos* os professores devem lecionar turmas usando *ambos* os métodos.

**Novo Delineamento (Corrigido):**
- Turma 1: Prof. Silva, Método X
- Turma 2: Prof. Silva, Método Y
- Turma 3: Profa. Santos, Método X
- Turma 4: Profa. Santos, Método Y
---

**Passo 2: Desenhar o Diagrama de Hasse do NOVO delineamento.**

.pull-left[
**Diagrama do Delineamento Corrigido:**
```{r, fig.height=3.5, echo=FALSE}
grViz("
digraph corrected {
  rankdir=TB;
  node [shape=circle, style=filled, fillcolor=lightblue]; edge[arrowhead=none];
  mu [label='μ']; epsilon [label='ε'];
  prof [label='Professor']; met [label='Método'];
  mu -> {prof, met}; {prof, met} -> epsilon;
  {rank=same; prof; met;}
}
")
```
]
.pull-right[
**Diagnóstico do Novo Delineamento:**
O diagrama agora mostra dois fatores cruzados. Os nós estão separados.

**Conclusão Corretiva:**
Este novo delineamento **é válido**. Ele nos permitirá ajustar um modelo `Nota ~ Professor * Método` e estimar separadamente:
]


1.  O efeito principal do `Professor` (se um é melhor que o outro, em média).
2.  O efeito principal do `Método` (se um é melhor que o outro, em média).
3.  A **interação**: será que o novo Método X funciona melhor com o professor experiente?

O uso do Diagrama de Hasse na fase de planejamento transformou um experimento falho em um delineamento fatorial robusto e informativo.
---

class: center, middle, inverse

## 3.4 Médias Parciais, Admissíveis e Identidades Algébricas

---
## Médias Parciais e Admissíveis

Em estudos experimentais, o valor de uma variável-resposta $Y$ é denotado como:
$y_{ijk...r}.$ Nesta notação, cada índice corresponde ao nível de um fator considerado. O último índice, `r`, porém, corresponde à réplica executada sob a combinação dos níveis de todos os fatores considerados.

- **Média parcial:** É a média das observações calculada sobre todos os níveis de um determinado fator ou conjunto de fatores.

**Exemplo:** Dois fatores (cruzados) estão sob estudo: A, com `a` níveis e B, com `b` níveis. Suponha que `n` denote o número de réplicas do experimento. As seguintes notações são estabelecidas:
.pull-left[
$$y_{ij.} = \sum_{r=1}^n y_{ijr} \implies \bar{y}_{ij.} = \frac{1}{n}y_{ij.}$$
$$y_{i..} = \sum_{j=1}^b \sum_{r=1}^n y_{ijr} \implies \bar{y}_{i..} = \frac{1}{bn}y_{i..}$$
]
.pull-rigth[
$$y_{.j.} = \sum_{i=1}^a \sum_{r=1}^n y_{ijr} \implies \bar{y}_{.j.} = \frac{1}{an}y_{.j.}$$
$$y_{...} = \sum_{i=1}^a \sum_{j=1}^b \sum_{r=1}^n y_{ijr} \implies \bar{y}_{...} = \frac{1}{abn}y_{...}$$]
---

### Exemplo Prático: Calculando Médias Parciais em R

Vamos usar um exemplo simples de `Droga` (Fator A, 2 níveis) x `Sexo` (Fator B, 2 níveis) com `n=3` réplicas para tornar isso concreto.
.pull-left[
```{r}
set.seed(101)
dados_med <- data.frame(
  Droga = factor(rep(c("A", "B"), each = 6)),
  Sexo = factor(rep(c("M", "F"), times = 2, each = 3)),
  Resposta = round(rnorm(12, mean=20, sd=5))
)
```
]
.pull-right[
```{r}
print(dados_med)
```
]
---
### Exemplo Prático: Significado das Médias Parciais

Vamos calcular e interpretar cada média usando `dplyr`.

.pull-left[
**1. Média da Célula ($\bar{y}_{ij.}$)**
Média para cada combinação específica.
```{r}
# a = 2, b = 2, n = 3
dados_med %>% 
  group_by(Droga, Sexo) %>% 
  summarise(Media_Célula = mean(Resposta))
```
**Interpretação:** É a resposta média para o grupo que recebeu a Droga A e é do Sexo M, etc. São os pontos em um gráfico de interação.
]
.pull-right[
**2. Média Geral ($\bar{y}_{...}$)**
A média de todas as observações.
```{r}
mean(dados_med$Resposta)
```
**Interpretação:** É a linha de base geral do experimento.
]
---
.pull-left[
**3. Média do Fator A ($\bar{y}_{i..}$)**
Média para cada nível de `Droga`, agregando sobre `Sexo`.
```{r}
dados_med %>% 
  group_by(Droga) %>% 
  summarise(Media_Droga = mean(Resposta))
```
**Interpretação:** Permite avaliar o **efeito principal** da Droga, ignorando o sexo dos pacientes.
]
.pull-right[
**4. Média do Fator B ($\bar{y}_{.j.}$)**
Média para cada nível de `Sexo`, agregando sobre `Droga`.
```{r}
dados_med %>% 
  group_by(Sexo) %>% 
  summarise(Media_Sexo = mean(Resposta))
```
**Interpretação:** Permite avaliar o **efeito principal** do Sexo, ignorando qual droga foi administrada.
]
---

## Média Parcial Admissível

**Definição:** Uma média parcial é dita **admissível** quando, estando presente um índice de um determinado fator, todos os índices de fatores que o embutem também estão presentes. Do contrário, a média parcial é dita inadmissível.

**Por que isso importa?** Para evitar cálculos que são numericamente possíveis, mas **cientificamente sem sentido**.

**Exemplo:** `Turma` (j) aninhada em `Escola` (i).
- $\bar{y}_{ij.}$ (média da turma `j` da escola `i`) é **admissível**. A identidade da turma `j` depende da escola `i`.
- $\bar{y}_{i..}$ (média da escola `i`) é **admissível**.
- $\bar{y}_{.j.}$ (média da "turma `j`" sobre todas as escolas) é **INADMISSÍVEL**. Não existe uma entidade "Turma 1" que seja comum a todas as escolas. Seria como tirar a média da renda da "Rua A" de Boa Viagem com a "Rua A" da Várzea; são lugares completamente diferentes.

A regra de admissibilidade é uma verificação de construção lógica imposta pela estrutura do seu experimento.
---

### EXERCÍCIO EM CLASSE 

**Identifique todas as médias admissíveis nos diagramas de Hasse do exercício do slide 29.**

(Notação: $y_{ijkr}$ para observação. A média geral $\bar{y}_{....}$ e a própria observação $y_{ijkr}$ são sempre admissíveis).

1.  **A, B, C Cruzados:** Nenhum fator está aninhado. **Todas as médias parciais são admissíveis**: $\bar{y}_{i...}$, $\bar{y}_{.j..}$, $\bar{y}_{..k.}$, $\bar{y}_{ij..}$, $\bar{y}_{i.k.}$, $\bar{y}_{.jk.}$, $\bar{y}_{ijk.}$.

2.  **A ⊃ B ⊃ C (Totalmente Aninhado):**
    - Para ter o índice `k` (de C), precisamos ter `j` (de B) e `i` (de A).
    - Para ter `j` (de B), precisamos ter `i` (de A).
    - **Admissíveis:** $\bar{y}_{i...}$, $\bar{y}_{ij..}$, $\bar{y}_{ijk.}$.

3.  **(A ⊃ B) x C:**
    - `B` está aninhado em `A`. `C` é cruzado.
    - Para ter `j` (de B), precisamos ter `i` (de A). O índice `k` (de C) é livre.
    - **Admissíveis:** $\bar{y}_{i...}$, $\bar{y}_{..k.}$, $\bar{y}_{ij..}$, $\bar{y}_{i.k.}$, $\bar{y}_{.jk.}$, $\bar{y}_{ijk.}$.
---

4.  **A ⊃ (B x C):**
    - `B` e `C` estão aninhados em `A`.
    - Para ter `j` (de B) ou `k` (de C), precisamos ter `i` (de A).
    - **Admissíveis:** $\bar{y}_{i...}$, $\bar{y}_{ij..}$, $\bar{y}_{i.k.}$, $\bar{y}_{ijk.}$.

5.  **Confundidos:** Como os fatores são indistinguíveis, apenas a média geral e a observação individual são interpretáveis.


## Identidades Algébricas

É possível representar cada observação
da variável resposta por meio de
identidades algébricas apropriadas que
são úteis para entender como cada
fator contribui para a formação dos
valores observados. A expressão a
seguir é um exemplo de uma identidade
algébrica.
$$y_{ir} = \bar{y}_{..} + (\bar{y}_{i.} - \bar{y}_{..}) + (y_{ir} - \bar{y}_{i.})$$
---
Uma identidade algébrica pode ser construída através dos seguintes passos:

**Passo 1:** Listar todas as médias parciais admissíveis iniciando pela média geral e
terminando com uma observação;

**Passo 2:** Localizar os índices que representam níveis de fatores que não possuem outros 
fatores embutidos, na média considerada.

**Passo 3:** Para cada média parcial listada no Passo 1, adicionar termos formados pela
eliminação dos índices localizados no Passo 2. Se o termo for formado pela eliminação de um número
ímpar de índices, ele 79receberá sinal negativo. Do contrário, receberá sinal positivo. 

**Passo 4:** Proceda à soma das parcelas geradas pelos passos anteriores.

---
### EXERCÍCIO EM CLASSE 

**Construir a identidade algébrica correspondente a um experimento com dois fatores cruzados e com réplicas.**

Seguindo os passos de listar as médias admissíveis e construir os termos, chegamos à identidade completa para um delineamento fatorial de dois fatores:

$$y_{ijr} = \bar{y}_{...} + (\bar{y}_{i..} - \bar{y}_{...}) + (\bar{y}_{.j.} - \bar{y}_{...}) + (\bar{y}_{ij.} - \bar{y}_{i..} - \bar{y}_{.j.} + \bar{y}_{...}) + (y_{ijr} - \bar{y}_{ij.})$$

**Mas o que significa cada um desses termos?**

Esta equação não é apenas uma manipulação matemática; ela é a **decomposição de uma observação individual em suas fontes de variação**. 

### Interpretando a Identidade Algébrica e a Conexão com a ANOVA

Cada componente da identidade algébrica corresponde diretamente a uma linha na tabela de Análise de Variância (ANOVA). A ANOVA simplesmente calcula a soma dos quadrados (a "energia") de cada um desses componentes vetoriais.
---
$$y_{ijr} = \underbrace{\bar{y}_{...}}_{\substack{\text{Média Geral} \\ \text{(Intercepto)}}} + \underbrace{(\bar{y}_{i..} - \bar{y}_{...})}_{\substack{\text{Efeito Principal de A} \\ \rightarrow SQ_A}} + \underbrace{(\bar{y}_{.j.} - \bar{y}_{...})}_{\substack{\text{Efeito Principal de B} \\ \rightarrow SQ_B}} + \underbrace{(\bar{y}_{ij.} - \bar{y}_{i..} - \bar{y}_{.j.} + \bar{y}_{...})}_{\substack{\text{Efeito da Interação A*B} \\ \rightarrow SQ_{A:B}}} + \underbrace{(y_{ijr} - \bar{y}_{ij.})}_{\substack{\text{Resíduo (Erro)} \\ \rightarrow SQ_{Erro}}}$$

- **Efeito Principal de A:** Mede o quanto a média do nível `i` do fator A desvia da média geral. Se somarmos os quadrados desses desvios para todas as observações, obtemos a Soma de Quadrados do Fator A ($SQ_A$).
- **Efeito Principal de B:** Mede o quanto a média do nível `j` do fator B desvia da média geral. A soma de seus quadrados é a $SQ_B$.
- **Efeito da Interação A*B:** Este é o termo mais sutil. Ele mede o "algo a mais" que a média da célula (`i,j`) possui que não pode ser explicado pela simples soma dos efeitos principais de A e B. A soma de seus quadrados é a $SQ_{A:B}$. Se este termo for grande, significa que o efeito de A depende do nível de B (e vice-versa).
- **Resíduo (Erro):** É a variação de uma observação individual em torno da média de sua própria célula. Representa a variabilidade aleatória e inexplicada. A soma de seus quadrados é a Soma de Quadrados do Erro ($SQ_{Erro}$).

**Conclusão:** A identidade algébrica é o mecanismo para a construção do ANOVA. Ela nos mostra exatamente como a variabilidade total de um dado é particionada entre as diferentes fontes de variação definidas pelo delineamento experimental.


